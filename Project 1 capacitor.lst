                  2   $LIST
0000              4   
0000              5   
0000              6   START_BUTTON     equ P0.0
0000              7   P1_BUTTON                equ     P2.4
0000              8   P2_BUTTON            equ         P2.6
0000              9   
0000             10   CLK           EQU 22118400
0000             11   TIMER0_RATE   EQU 2048     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             12   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             13   TIMER1_RATE   EQU 4000                 ;2000Hz frequency lose frequency
0000             14   TIMER2_RATE   EQU 4200                 ;2100Hz frequency win frequency
0000             15   TIMER1_RELOAD EQU ((65536-(CLK/TIMER1_RATE)))
0000             16   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             17   
0000             18   org 0000H
0000 020453      19      ljmp MyProgram
0003             20   
000B             21   org 0x000B
000B 0203CB      22            ljmp Timer0_ISR
000E             23   
0030             24   DSEG at 30H
0030             25   x:   ds 4
0034             26   y:   ds 4
0038             27   seed: ds 4  
003C             28   bcd: ds 5
0041             29   p1points: ds 1
0042             30   p2points: ds 1
0043             31   
0000             32   BSEG
0000             33   mf: dbit 1
0001             34   p1_press: dbit 1
0002             35   p2_press: dbit 1
0003             36   
000E             37   cseg
000E             38   ; These 'equ' must match the hardware wiring
000E             39   LCD_RS equ P3.2
000E             40   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
000E             41   LCD_E  equ P3.3
000E             42   LCD_D4 equ P3.4
000E             43   LCD_D5 equ P3.5
000E             44   LCD_D6 equ P3.6
000E             45   LCD_D7 equ P3.7
000E             46   SOUND_OUT equ P1.1
000E             47   
000E 506C6179    48   Initial_Message:  db 'Player1:          ', 0
     6572313A
     20202020
     20202020
     202000
0021 506C6179    49   Initial_Message2: db 'Player2:          ', 0
     6572323A
     20202020
     20202020
     202000
0034             50   
0034 57696E6E    51   Winner1_message1: db 'Winner!:D', 0
     6572213A
     4400
003E 4C6F7365    52   Winner1_message2: db 'Loser:P', 0
     723A5000
0046             53   
0046 4C6F7365    54   Winner2_message1: db 'Loser:P', 0
     723A5000
004E 57696E6E    55   Winner2_message2: db 'Winner!:D', 0
     6572213A
     4400
0058             56   
0058 506C6179    57   Playagain       : db 'Play again ?', 0
     20616761
     696E203F
     00
0065 20202020    58   Clear_screen    : db '          ', 0
     20202020
     202000
0070             59   
                570   $LIST
                 62   $LIST
03B2             64   
03B2             65   Timer0_Init:
03B2 E589        66            mov a, TMOD
03B4 54F0        67            anl a, #0xf0 ; Clear the bits for timer 0
03B6 4401        68            orl a, #0x01 ; Configure timer 0 as 16-timer
03B8 F589        69            mov TMOD, a
03BA 758CD5      70            mov TH0, #high(TIMER0_RELOAD)
03BD 758AD0      71            mov TL0, #low(TIMER0_RELOAD)
03C0             72            ; Set autoreload value
03C0 75F4D5      73            mov RH0, #high(TIMER0_RELOAD)
03C3 75F2D0      74            mov RL0, #low(TIMER0_RELOAD)
03C6             75            ; Enable the timer and interrupts
03C6 D2A9        76       setb ET0  ; Enable timer 0 interrupt
03C8 C28C        77       clr TR0  ; Start timer 0
03CA 22          78            ret
03CB             79   
03CB             80   ;---------------------------------;
03CB             81   ; ISR for timer 0.  Set to execute;
03CB             82   ; every 1/4096Hz to generate a    ;
03CB             83   ; 2048 Hz square wave at pin P1.1 ;
03CB             84   ;---------------------------------;
03CB             85   Timer0_ISR:
03CB             86            ;clr TF0  ; According to the data sheet this is done for us already.
03CB B291        87            cpl SOUND_OUT ; Connect speaker to P1.1!
03CD 32          88            reti
03CE             89   
03CE             90   Timer0_Init1:
03CE E589        91            mov a, TMOD
03D0 54F0        92            anl a, #0xf0 ; Clear the bits for timer 0
03D2 4401        93            orl a, #0x01 ; Configure timer 0 as 16-timer
03D4 F589        94            mov TMOD, a
03D6 758CEA      95            mov TH0, #high(TIMER1_RELOAD)
03D9 758A67      96            mov TL0, #low(TIMER1_RELOAD)
03DC             97            ; Set autoreload value
03DC 75F4EA      98            mov RH0, #high(TIMER1_RELOAD)
03DF 75F267      99            mov RL0, #low(TIMER1_RELOAD)
03E2            100            ; Enable the timer and interrupts
03E2 D2A9       101       setb ET0  ; Enable timer 0 interrupt
03E4 C28C       102       clr TR0  ; Start timer 0
03E6 22         103            ret
03E7            104   
03E7            105   ;---------------------------------;
03E7            106   ; ISR for timer 0.  Set to execute;
03E7            107   ; every 1/4096Hz to generate a    ;
03E7            108   ; 2048 Hz square wave at pin P1.1 ;
03E7            109   ;---------------------------------;
03E7            110   Timer0_ISR1:
03E7            111            ;clr TF0  ; According to the data sheet this is done for us already.
03E7 B291       112            cpl SOUND_OUT ; Connect speaker to P1.1!
03E9 32         113            reti
03EA            114   
03EA            115   
03EA            116   ;---------------------------------;
03EA            117   ; ISR for timer 0.  Set to execute;
03EA            118   ; every 1/4096Hz to generate a    ;
03EA            119   ; 2048 Hz square wave at pin P1.1 ;
03EA            120   ;---------------------------------;
03EA            121   
03EA            122   
03EA            123   Wait1s:
03EA 7AB0       124       mov R2, #176
03EC 79FA       125   X3: mov R1, #250
03EE 78A6       126   X2: mov R0, #166
03F0 D8FE       127   X1: djnz R0, X1 ; 3 cycles->3*45.21123ns*166=22.51519us
03F2 D9FA       128       djnz R1, X2 ; 22.51519us*250=5.629ms
03F4 DAF6       129       djnz R2, X3 ; 5.629ms*176=1.0s (approximately)
03F6 22         130       ret
03F7            131   
03F7            132   random:
03F7 853830     133       mov x+0, seed+0
03FA 853931     134       mov x+1, seed+1
03FD 853A32     135       mov x+2, seed+2
0400 853B33     136       mov x+3, seed+3
0403 7534FD     137            mov y+0, #low (214013 % 0x10000) 
0406 753543     137            mov y+1, #high(214013 % 0x10000) 
0409 753603     137            mov y+2, #low (214013 / 0x10000) 
040C 753700     137            mov y+3, #high(214013 / 0x10000) 
040F 120296     138       lcall mul32
0412 753443     139            mov y+0, #low (2451011 % 0x10000) 
0415 753566     139            mov y+1, #high(2451011 % 0x10000) 
0418 753625     139            mov y+2, #low (2451011 / 0x10000) 
041B 753700     139            mov y+3, #high(2451011 / 0x10000) 
041E 1201E1     140       lcall add32
0421 853038     141       mov seed+0, x+0
0424 853139     142       mov seed+1, x+1
0427 85323A     143       mov seed+2, x+2
042A 85333B     144       mov seed+3, x+3
042D 22         145       ret
042E            146   wait_random:
042E C002       147            push AR2
0430 AA38       147            mov R2, seed+0
0432 12007B     147            lcall ?Wait_Milli_Seconds
0435 D002       147            pop AR2
0437 C002       148            push AR2
0439 AA39       148            mov R2, seed+1
043B 12007B     148            lcall ?Wait_Milli_Seconds
043E D002       148            pop AR2
0440 C002       149            push AR2
0442 AA3A       149            mov R2, seed+2
0444 12007B     149            lcall ?Wait_Milli_Seconds
0447 D002       149            pop AR2
0449 C002       150            push AR2
044B AA3B       150            mov R2, seed+3
044D 12007B     150            lcall ?Wait_Milli_Seconds
0450 D002       150            pop AR2
0452 22         151       ret
0453            152   
0453            153   MyProgram:
0453 1203B2     154       lcall Timer0_Init
0456            155       ;lcall Timer2_Init
0456 C0E0       156            push acc
0458 7401       156            mov a, #1
045A 14         156            dec a
045B 120101     156            lcall ?Set_Cursor_1 ; Select column and row
045E D0E0       156            pop acc
0460 C083       157            push dph
0462 C082       157            push dpl
0464 C0E0       157            push acc
0466 90000E     157            mov dptr, #Initial_Message
0469 1200F4     157            lcall ?Send_Constant_String
046C D0E0       157            pop acc
046E D082       157            pop dpl
0470 D083       157            pop dph
0472 C0E0       158            push acc
0474 7401       158            mov a, #1
0476 14         158            dec a
0477 1200FF     158            lcall ?Set_Cursor_2 ; Select column and row
047A D0E0       158            pop acc
047C C083       159            push dph
047E C082       159            push dpl
0480 C0E0       159            push acc
0482 900021     159            mov dptr, #Initial_Message2
0485 1200F4     159            lcall ?Send_Constant_String
0488 D0E0       159            pop acc
048A D082       159            pop dpl
048C D083       159            pop dph
048E 754100     160       mov p1points, #0x00
0491 754200     161       mov p2points, #0x00
0494 D2AF       162       setb EA
0496 D28C       163       setb TR0
0498 20C5FD     164       jb P4.5, $
049B 85CD38     165       mov seed+0, TH2
049E 753901     166       mov seed+1, #0x01
04A1 753A87     167       mov seed+2, #0x87
04A4 85CC3B     168       mov seed+3, TL2
04A7 C28C       169       clr TR0
04A9 C2CA       170       clr TR2
04AB 1203CE     171       lcall Timer0_Init1
04AE 0204B1     172       ljmp loop
04B1            173   loop:
04B1 C0E0       174            push acc
04B3 740B       174            mov a, #11
04B5 14         174            dec a
04B6 120101     174            lcall ?Set_Cursor_1 ; Select column and row
04B9 D0E0       174            pop acc
04BB C000       175            push ar0
04BD A841       175            mov r0, p1points
04BF 120106     175            lcall ?Display_BCD
04C2 D000       175            pop ar0
04C4 C0E0       176            push acc
04C6 740B       176            mov a, #11
04C8 14         176            dec a
04C9 1200FF     176            lcall ?Set_Cursor_2 ; Select column and row
04CC D0E0       176            pop acc
04CE C000       177            push ar0
04D0 A842       177            mov r0, p2points
04D2 120106     177            lcall ?Display_BCD
04D5 D000       177            pop ar0
04D7 D28C       178       setb TR0
04D9 208012     179       jb START_BUTTON, start_game
04DC C002       180            push AR2
04DE 7A32       180            mov R2, #50
04E0 12007B     180            lcall ?Wait_Milli_Seconds
04E3 D002       180            pop AR2
04E5 208006     181       jb START_BUTTON, start_game
04E8 3080FD     182       jnb START_BUTTON, $
04EB 0204B1     183       ljmp loop
04EE            184   
04EE            185   start_game:
04EE C0E0       186            push acc
04F0 740B       186            mov a, #11
04F2 14         186            dec a
04F3 120101     186            lcall ?Set_Cursor_1 ; Select column and row
04F6 D0E0       186            pop acc
04F8 C000       187            push ar0
04FA A841       187            mov r0, p1points
04FC 120106     187            lcall ?Display_BCD
04FF D000       187            pop ar0
0501 C0E0       188            push acc
0503 740B       188            mov a, #11
0505 14         188            dec a
0506 1200FF     188            lcall ?Set_Cursor_2 ; Select column and row
0509 D0E0       188            pop acc
050B C000       189            push ar0
050D A842       189            mov r0, p2points
050F 120106     189            lcall ?Display_BCD
0512 D000       189            pop ar0
0514 1203F7     190       lcall random
0517 12042E     191       lcall wait_random
051A E539       192       mov a, seed+1
051C A2E3       193       mov c, acc.3
051E            194       ;mov HLbit, c
051E 4003       195       jc lose_tone
0520 020528     196       ljmp win_tone
0523            197   
0523            198   lose_tone:
0523            199       ;ljmp play_lose
0523 D28C       200       setb TR0
0525 020573     201       ljmp start_game_nohit1
0528            202   win_tone: 
0528            203       ;ljmp play_win
0528 D28E       204       setb TR1
052A 02052D     205       ljmp start_game_hit1
052D            206       
052D            207   
052D            208   start_game_hit1:
052D 20A420     209       jb P1_BUTTON, start_game_hit2
0530 C002       210            push AR2
0532 7A32       210            mov R2, #50
0534 12007B     210            lcall ?Wait_Milli_Seconds
0537 D002       210            pop AR2
0539 20A414     211       jb P1_BUTTON, start_game_hit2
053C 30A4FD     212       jnb P1_BUTTON, $
053F E4         213       clr a 
0540 E541       214       mov a, p1points
0542 2401       215       add a, #0x01
0544 F542       216       mov p2points, a
0546 B40504     217       cjne a, #0x05, p1win_jmp
0549 E4         218       clr a
054A 0204EE     219       ljmp start_game
054D            220   
054D            221   p1win_jmp:
054D 0205DA     222       ljmp p1win
0550            223   
0550            224   start_game_hit2:
0550 20A6DA     225       jb P2_BUTTON, start_game_hit1
0553 C002       226            push AR2
0555 7A32       226            mov R2, #50
0557 12007B     226            lcall ?Wait_Milli_Seconds
055A D002       226            pop AR2
055C 20A6CE     227       jb P2_BUTTON, start_game_hit1
055F 30A6FD     228       jnb P2_BUTTON, $
0562 E4         229       clr a 
0563 E542       230       mov a, p2points
0565 2401       231       add a, #0x01
0567 F542       232       mov p2points, a
0569 B40504     233       cjne a, #0x05, p2win_jmp
056C E4         234       clr a
056D 0204EE     235       ljmp start_game
0570            236   
0570            237   p2win_jmp:
0570 020661     238       ljmp p2win
0573            239   
0573            240   start_game_nohit1:
0573 20A42F     241       jb P1_BUTTON, start_game_nohit2
0576 C002       242            push AR2
0578 7A32       242            mov R2, #50
057A 12007B     242            lcall ?Wait_Milli_Seconds
057D D002       242            pop AR2
057F 20A423     243       jb P1_BUTTON, start_game_nohit2
0582 30A4FD     244       jnb P1_BUTTON, $
0585 E4         245       clr a 
0586 E541       246       mov a, p1points
0588 B4004C     247       cjne a, #0x00, start_jmp
058B F530       248       mov x, a
058D 753401     249            mov y+0, #low (1 % 0x10000) 
0590 753500     249            mov y+1, #high(1 % 0x10000) 
0593 753600     249            mov y+2, #low (1 / 0x10000) 
0596 753700     249            mov y+3, #high(1 / 0x10000) 
0599 120202     250       lcall sub32
059C E530       251       mov a, x
059E D4         252       da a
059F F541       253       mov p1points, a
05A1 E4         254       clr a
05A2 0204EE     255       ljmp start_game
05A5            256   
05A5            257   start_game_nohit2:
05A5 20A6CB     258       jb P2_BUTTON, start_game_nohit1
05A8 C002       259            push AR2
05AA 7A32       259            mov R2, #50
05AC 12007B     259            lcall ?Wait_Milli_Seconds
05AF D002       259            pop AR2
05B1 20A6BF     260       jb P2_BUTTON, start_game_nohit1
05B4 30A6FD     261       jnb P2_BUTTON, $
05B7 E4         262       clr a 
05B8 E542       263       mov a, p2points
05BA B4001A     264       cjne a, #0x00, start_jmp
05BD F530       265       mov x, a
05BF 753401     266            mov y+0, #low (1 % 0x10000) 
05C2 753500     266            mov y+1, #high(1 % 0x10000) 
05C5 753600     266            mov y+2, #low (1 / 0x10000) 
05C8 753700     266            mov y+3, #high(1 / 0x10000) 
05CB 120202     267       lcall sub32
05CE E530       268       mov a, x
05D0 D4         269       da a
05D1 F542       270       mov p2points, a
05D3 E4         271       clr a
05D4 0205D7     272       ljmp start_jmp
05D7            273   
05D7            274   start_jmp:
05D7 0204EE     275       ljmp start_game
05DA            276   p1win:  
05DA C0E0       277            push acc
05DC 7409       277            mov a, #9
05DE 14         277            dec a
05DF 120101     277            lcall ?Set_Cursor_1 ; Select column and row
05E2 D0E0       277            pop acc
05E4 C083       278            push dph
05E6 C082       278            push dpl
05E8 C0E0       278            push acc
05EA 900034     278            mov dptr, #Winner1_message1
05ED 1200F4     278            lcall ?Send_Constant_String
05F0 D0E0       278            pop acc
05F2 D082       278            pop dpl
05F4 D083       278            pop dph
05F6 C083       279            push dph
05F8 C082       279            push dpl
05FA C0E0       279            push acc
05FC 90003E     279            mov dptr, #Winner1_message2
05FF 1200F4     279            lcall ?Send_Constant_String
0602 D0E0       279            pop acc
0604 D082       279            pop dpl
0606 D083       279            pop dph
0608 C002       280            push AR2
060A 7A05       280            mov R2, #5
060C 12007B     280            lcall ?Wait_Milli_Seconds
060F D002       280            pop AR2
0611            280   
0611 C0E0       281            push acc
0613 7401       281            mov a, #1
0615 14         281            dec a
0616 120101     281            lcall ?Set_Cursor_1 ; Select column and row
0619 D0E0       281            pop acc
061B C083       282            push dph
061D C082       282            push dpl
061F C0E0       282            push acc
0621 900058     282            mov dptr, #Playagain
0624 1200F4     282            lcall ?Send_Constant_String
0627 D0E0       282            pop acc
0629 D082       282            pop dpl
062B D083       282            pop dph
062D C0E0       283            push acc
062F 7401       283            mov a, #1
0631 14         283            dec a
0632 1200FF     283            lcall ?Set_Cursor_2 ; Select column and row
0635 D0E0       283            pop acc
0637 C083       284            push dph
0639 C082       284            push dpl
063B C0E0       284            push acc
063D 900065     284            mov dptr, #Clear_screen
0640 1200F4     284            lcall ?Send_Constant_String
0643 D0E0       284            pop acc
0645 D082       284            pop dpl
0647 D083       284            pop dph
0649 20A612     285       jb P2_BUTTON, p1win_jmp2
064C C002       286            push AR2
064E 7A05       286            mov R2, #5
0650 12007B     286            lcall ?Wait_Milli_Seconds
0653 D002       286            pop AR2
0655 20A606     287       jb P2_BUTTON, p1win_jmp2
0658 30A6FD     288       jnb P2_BUTTON, $
065B 0206F5     289       ljmp restart_jmp
065E            290   p1win_jmp2:
065E 0205DA     291       ljmp p1win
0661            292   p2win: 
0661 C0E0       293            push acc
0663 7409       293            mov a, #9
0665 14         293            dec a
0666 120101     293            lcall ?Set_Cursor_1 ; Select column and row
0669 D0E0       293            pop acc
066B C083       294            push dph
066D C082       294            push dpl
066F C0E0       294            push acc
0671 900046     294            mov dptr, #Winner2_message1
0674 1200F4     294            lcall ?Send_Constant_String
0677 D0E0       294            pop acc
0679 D082       294            pop dpl
067B D083       294            pop dph
067D C0E0       295            push acc
067F 7409       295            mov a, #9
0681 14         295            dec a
0682 1200FF     295            lcall ?Set_Cursor_2 ; Select column and row
0685 D0E0       295            pop acc
0687 C083       296            push dph
0689 C082       296            push dpl
068B C0E0       296            push acc
068D 90004E     296            mov dptr, #Winner2_message2
0690 1200F4     296            lcall ?Send_Constant_String
0693 D0E0       296            pop acc
0695 D082       296            pop dpl
0697 D083       296            pop dph
0699 C002       297            push AR2
069B 7A32       297            mov R2, #50
069D 12007B     297            lcall ?Wait_Milli_Seconds
06A0 D002       297            pop AR2
06A2 C0E0       298            push acc
06A4 7401       298            mov a, #1
06A6 14         298            dec a
06A7 120101     298            lcall ?Set_Cursor_1 ; Select column and row
06AA D0E0       298            pop acc
06AC C083       299            push dph
06AE C082       299            push dpl
06B0 C0E0       299            push acc
06B2 900058     299            mov dptr, #Playagain
06B5 1200F4     299            lcall ?Send_Constant_String
06B8 D0E0       299            pop acc
06BA D082       299            pop dpl
06BC D083       299            pop dph
06BE C0E0       300            push acc
06C0 7401       300            mov a, #1
06C2 14         300            dec a
06C3 1200FF     300            lcall ?Set_Cursor_2 ; Select column and row
06C6 D0E0       300            pop acc
06C8 C083       301            push dph
06CA C082       301            push dpl
06CC C0E0       301            push acc
06CE 900065     301            mov dptr, #Clear_screen
06D1 1200F4     301            lcall ?Send_Constant_String
06D4 D0E0       301            pop acc
06D6 D082       301            pop dpl
06D8 D083       301            pop dph
06DA 20A612     302       jb P2_BUTTON, p1win_jmp1
06DD C002       303            push AR2
06DF 7A32       303            mov R2, #50
06E1 12007B     303            lcall ?Wait_Milli_Seconds
06E4 D002       303            pop AR2
06E6 20A606     304       jb P2_BUTTON, p1win_jmp1
06E9 30A6FD     305       jnb P2_BUTTON, $
06EC 0206F5     306       ljmp restart_jmp
06EF            307   
06EF            308   p1win_jmp1:
06EF 0205DA     309       ljmp p1win
06F2            310   
06F2            311   p2win_jmp2:
06F2 020661     312       ljmp p2win
06F5            313   
06F5            314   restart_jmp:
06F5 0206F8     315       ljmp restart_game
06F8            316   
06F8            317   restart_game:
06F8 754100     318       mov p1points, #0x00
06FB 754200     319       mov p2points, #0x00
06FE 0204EE     320       ljmp start_game
0701            321   en
