                  2   $LIST
0000              4   
0000              5   
0000              6   START_BUTTON     equ P0.0
0000              7   P1_BUTTON                equ     P2.4
0000              8   P2_BUTTON            equ         P2.6
0000              9   
0000             10   CLK           EQU 22118400
0000             11   TIMER0_RATE   EQU 2048     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             12   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             13   TIMER1_RATE   EQU 4000                 ;2000Hz frequency lose frequency
0000             14   TIMER2_RATE   EQU 4200                 ;2100Hz frequency win frequency
0000             15   TIMER1_RELOAD EQU ((65536-(CLK/TIMER1_RATE)))
0000             16   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             17   
0000             18   org 0000H
0000 020453      19      ljmp MyProgram
0003             20   
000B             21   org 0x000B
000B 0203CB      22            ljmp Timer0_ISR
000E             23   
0030             24   DSEG at 30H
0030             25   x:   ds 4
0034             26   y:   ds 4
0038             27   seed: ds 4  
003C             28   bcd: ds 5
0041             29   p1points: ds 1
0042             30   p2points: ds 1
0043             31   
0000             32   BSEG
0000             33   mf: dbit 1
0001             34   p1_press: dbit 1
0002             35   p2_press: dbit 1
0003             36   
000E             37   cseg
000E             38   ; These 'equ' must match the hardware wiring
000E             39   LCD_RS equ P3.2
000E             40   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
000E             41   LCD_E  equ P3.3
000E             42   LCD_D4 equ P3.4
000E             43   LCD_D5 equ P3.5
000E             44   LCD_D6 equ P3.6
000E             45   LCD_D7 equ P3.7
000E             46   SOUND_OUT equ P1.1
000E             47   
000E 506C6179    48   Initial_Message:  db 'Player1:          ', 0
     6572313A
     20202020
     20202020
     202000
0021 506C6179    49   Initial_Message2: db 'Player2:          ', 0
     6572323A
     20202020
     20202020
     202000
0034             50   
0034 57696E6E    51   Winner1_message1: db 'Winner!:D', 0
     6572213A
     4400
003E 4C6F7365    52   Winner1_message2: db 'Loser:P', 0
     723A5000
0046             53   
0046 4C6F7365    54   Winner2_message1: db 'Loser:P', 0
     723A5000
004E 57696E6E    55   Winner2_message2: db 'Winner!:D', 0
     6572213A
     4400
0058             56   
0058 506C6179    57   Playagain       : db 'Play again ?', 0
     20616761
     696E203F
     00
0065 20202020    58   Clear_screen    : db '          ', 0
     20202020
     202000
0070             59   
                570   $LIST
                 62   $LIST
03B2             64   
03B2             65   Timer0_Init:
03B2 E589        66            mov a, TMOD
03B4 54F0        67            anl a, #0xf0 ; Clear the bits for timer 0
03B6 4401        68            orl a, #0x01 ; Configure timer 0 as 16-timer
03B8 F589        69            mov TMOD, a
03BA 758CD5      70            mov TH0, #high(TIMER0_RELOAD)
03BD 758AD0      71            mov TL0, #low(TIMER0_RELOAD)
03C0             72            ; Set autoreload value
03C0 75F4D5      73            mov RH0, #high(TIMER0_RELOAD)
03C3 75F2D0      74            mov RL0, #low(TIMER0_RELOAD)
03C6             75            ; Enable the timer and interrupts
03C6 D2A9        76       setb ET0  ; Enable timer 0 interrupt
03C8 C28C        77       clr TR0  ; Start timer 0
03CA 22          78            ret
03CB             79   
03CB             80   ;---------------------------------;
03CB             81   ; ISR for timer 0.  Set to execute;
03CB             82   ; every 1/4096Hz to generate a    ;
03CB             83   ; 2048 Hz square wave at pin P1.1 ;
03CB             84   ;---------------------------------;
03CB             85   Timer0_ISR:
03CB             86            ;clr TF0  ; According to the data sheet this is done for us already.
03CB B291        87            cpl SOUND_OUT ; Connect speaker to P1.1!
03CD 32          88            reti
03CE             89   
03CE             90   Timer0_Init1:
03CE E589        91            mov a, TMOD
03D0 54F0        92            anl a, #0xf0 ; Clear the bits for timer 0
03D2 4401        93            orl a, #0x01 ; Configure timer 0 as 16-timer
03D4 F589        94            mov TMOD, a
03D6 758CEA      95            mov TH0, #high(TIMER1_RELOAD)
03D9 758A67      96            mov TL0, #low(TIMER1_RELOAD)
03DC             97            ; Set autoreload value
03DC 75F4EA      98            mov RH0, #high(TIMER1_RELOAD)
03DF 75F267      99            mov RL0, #low(TIMER1_RELOAD)
03E2            100            ; Enable the timer and interrupts
03E2 D2A9       101       setb ET0  ; Enable timer 0 interrupt
03E4 C28C       102       clr TR0  ; Start timer 0
03E6 22         103            ret
03E7            104   
03E7            105   ;---------------------------------;
03E7            106   ; ISR for timer 0.  Set to execute;
03E7            107   ; every 1/4096Hz to generate a    ;
03E7            108   ; 2048 Hz square wave at pin P1.1 ;
03E7            109   ;---------------------------------;
03E7            110   Timer0_ISR1:
03E7            111            ;clr TF0  ; According to the data sheet this is done for us already.
03E7 B291       112            cpl SOUND_OUT ; Connect speaker to P1.1!
03E9 32         113            reti
03EA            114   
03EA            115   
03EA            116   ;---------------------------------;
03EA            117   ; ISR for timer 0.  Set to execute;
03EA            118   ; every 1/4096Hz to generate a    ;
03EA            119   ; 2048 Hz square wave at pin P1.1 ;
03EA            120   ;---------------------------------;
03EA            121   
03EA            122   
03EA            123   Wait1s:
03EA 7AB0       124       mov R2, #176
03EC 79FA       125   X3: mov R1, #250
03EE 78A6       126   X2: mov R0, #166
03F0 D8FE       127   X1: djnz R0, X1 ; 3 cycles->3*45.21123ns*166=22.51519us
03F2 D9FA       128       djnz R1, X2 ; 22.51519us*250=5.629ms
03F4 DAF6       129       djnz R2, X3 ; 5.629ms*176=1.0s (approximately)
03F6 22         130       ret
03F7            131   
03F7            132   random:
03F7 853830     133       mov x+0, seed+0
03FA 853931     134       mov x+1, seed+1
03FD 853A32     135       mov x+2, seed+2
0400 853B33     136       mov x+3, seed+3
0403 7534FD     137            mov y+0, #low (214013 % 0x10000) 
0406 753543     137            mov y+1, #high(214013 % 0x10000) 
0409 753603     137            mov y+2, #low (214013 / 0x10000) 
040C 753700     137            mov y+3, #high(214013 / 0x10000) 
040F 120296     138       lcall mul32
0412 753443     139            mov y+0, #low (2451011 % 0x10000) 
0415 753566     139            mov y+1, #high(2451011 % 0x10000) 
0418 753625     139            mov y+2, #low (2451011 / 0x10000) 
041B 753700     139            mov y+3, #high(2451011 / 0x10000) 
041E 1201E1     140       lcall add32
0421 853038     141       mov seed+0, x+0
0424 853139     142       mov seed+1, x+1
0427 85323A     143       mov seed+2, x+2
042A 85333B     144       mov seed+3, x+3
042D 22         145       ret
042E            146   wait_random:
042E C002       147            push AR2
0430 AA38       147            mov R2, seed+0
0432 12007B     147            lcall ?Wait_Milli_Seconds
0435 D002       147            pop AR2
0437 C002       148            push AR2
0439 AA39       148            mov R2, seed+1
043B 12007B     148            lcall ?Wait_Milli_Seconds
043E D002       148            pop AR2
0440 C002       149            push AR2
0442 AA3A       149            mov R2, seed+2
0444 12007B     149            lcall ?Wait_Milli_Seconds
0447 D002       149            pop AR2
0449 C002       150            push AR2
044B AA3B       150            mov R2, seed+3
044D 12007B     150            lcall ?Wait_Milli_Seconds
0450 D002       150            pop AR2
0452 22         151       ret
0453            152   
0453            153   MyProgram:
0453 1203B2     154       lcall Timer0_Init
0456            155       ;lcall Timer2_Init
0456 C0E0       156            push acc
0458 7401       156            mov a, #1
045A 14         156            dec a
045B 120101     156            lcall ?Set_Cursor_1 ; Select column and row
045E D0E0       156            pop acc
0460 C083       157            push dph
0462 C082       157            push dpl
0464 C0E0       157            push acc
0466 90000E     157            mov dptr, #Initial_Message
0469 1200F4     157            lcall ?Send_Constant_String
046C D0E0       157            pop acc
046E D082       157            pop dpl
0470 D083       157            pop dph
0472 C0E0       158            push acc
0474 7401       158            mov a, #1
0476 14         158            dec a
0477 1200FF     158            lcall ?Set_Cursor_2 ; Select column and row
047A D0E0       158            pop acc
047C C083       159            push dph
047E C082       159            push dpl
0480 C0E0       159            push acc
0482 900021     159            mov dptr, #Initial_Message2
0485 1200F4     159            lcall ?Send_Constant_String
0488 D0E0       159            pop acc
048A D082       159            pop dpl
048C D083       159            pop dph
048E D2AF       160       setb EA
0490 C28C       161       clr TR0
0492 20C5FD     162       jb P4.5, $
0495 85CD38     163       mov seed+0, TH2
0498 753901     164       mov seed+1, #0x01
049B 753A87     165       mov seed+2, #0x87
049E 85CC3B     166       mov seed+3, TL2
04A1 754100     167       mov p1points, #0x00
04A4 754200     168       mov p2points, #0x00
04A7 0204AA     169       ljmp loop
04AA            170   loop:
04AA C0E0       171            push acc
04AC 740B       171            mov a, #11
04AE 14         171            dec a
04AF 120101     171            lcall ?Set_Cursor_1 ; Select column and row
04B2 D0E0       171            pop acc
04B4 C000       172            push ar0
04B6 A841       172            mov r0, p1points
04B8 120106     172            lcall ?Display_BCD
04BB D000       172            pop ar0
04BD C0E0       173            push acc
04BF 740B       173            mov a, #11
04C1 14         173            dec a
04C2 1200FF     173            lcall ?Set_Cursor_2 ; Select column and row
04C5 D0E0       173            pop acc
04C7 C000       174            push ar0
04C9 A842       174            mov r0, p2points
04CB 120106     174            lcall ?Display_BCD
04CE D000       174            pop ar0
04D0 208012     175       jb START_BUTTON, start_game
04D3 C002       176            push AR2
04D5 7A32       176            mov R2, #50
04D7 12007B     176            lcall ?Wait_Milli_Seconds
04DA D002       176            pop AR2
04DC 208006     177       jb START_BUTTON, start_game
04DF 3080FD     178       jnb START_BUTTON, $
04E2 0204AA     179       ljmp loop
04E5            180   
04E5            181   start_game:
04E5 C0E0       182            push acc
04E7 740B       182            mov a, #11
04E9 14         182            dec a
04EA 120101     182            lcall ?Set_Cursor_1 ; Select column and row
04ED D0E0       182            pop acc
04EF C000       183            push ar0
04F1 A841       183            mov r0, p1points
04F3 120106     183            lcall ?Display_BCD
04F6 D000       183            pop ar0
04F8 C0E0       184            push acc
04FA 740B       184            mov a, #11
04FC 14         184            dec a
04FD 1200FF     184            lcall ?Set_Cursor_2 ; Select column and row
0500 D0E0       184            pop acc
0502 C000       185            push ar0
0504 A842       185            mov r0, p2points
0506 120106     185            lcall ?Display_BCD
0509 D000       185            pop ar0
050B 1203F7     186       lcall random
050E 12042E     187       lcall wait_random
0511 E539       188       mov a, seed+1
0513 A2E3       189       mov c, acc.3
0515            190       ;mov HLbit, c
0515 4003       191       jc lose_tone
0517 020522     192       ljmp win_tone
051A            193   
051A            194   lose_tone:
051A            195       ;ljmp play_lose
051A 1203CE     196       lcall Timer0_Init1
051D D28C       197       setb TR0
051F 020574     198       ljmp start_game_nohit1
0522            199   win_tone: 
0522            200       ;ljmp play_win
0522 1203CE     201       lcall Timer0_Init1
0525 D28C       202       setb TR0
0527 02052A     203       ljmp start_game_hit1
052A            204       
052A            205   
052A            206   start_game_hit1:
052A 200122     207       jb p1_press, start_game_hit2
052D C002       208            push AR2
052F 7A32       208            mov R2, #50
0531 12007B     208            lcall ?Wait_Milli_Seconds
0534 D002       208            pop AR2
0536 200116     209       jb p1_press, start_game_hit2
0539 3001FD     210       jnb p1_press, $
053C C28C       211       clr TR0
053E E4         212       clr a 
053F E541       213       mov a, p1points
0541 2401       214       add a, #0x01
0543 F542       215       mov p2points, a
0545 B40504     216       cjne a, #0x05, p1win_jmp
0548 E4         217       clr a
0549 0204E5     218       ljmp start_game
054C            219   
054C            220   p1win_jmp:
054C 0205DF     221       ljmp p1win
054F            222   
054F            223   start_game_hit2:
054F 2002D8     224       jb p2_press, start_game_hit1
0552 C002       225            push AR2
0554 7A32       225            mov R2, #50
0556 12007B     225            lcall ?Wait_Milli_Seconds
0559 D002       225            pop AR2
055B 2002CC     226       jb p2_press, start_game_hit1
055E 3002FD     227       jnb p2_press, $
0561 C28C       228       clr TR0
0563 E4         229       clr a 
0564 E542       230       mov a, p2points
0566 2401       231       add a, #0x01
0568 F542       232       mov p2points, a
056A B40504     233       cjne a, #0x05, p2win_jmp
056D E4         234       clr a
056E 0204E5     235       ljmp start_game
0571            236   
0571            237   p2win_jmp:
0571 020666     238       ljmp p2win
0574            239   
0574            240   start_game_nohit1:
0574 200131     241       jb p1_press, start_game_nohit2
0577 C002       242            push AR2
0579 7A32       242            mov R2, #50
057B 12007B     242            lcall ?Wait_Milli_Seconds
057E D002       242            pop AR2
0580 200125     243       jb p1_press, start_game_nohit2
0583 3001FD     244       jnb p1_press, $
0586 C28C       245       clr TR0
0588 E4         246       clr a 
0589 E541       247       mov a, p1points
058B B4004E     248       cjne a, #0x00, start_jmp
058E F530       249       mov x, a
0590 753401     250            mov y+0, #low (1 % 0x10000) 
0593 753500     250            mov y+1, #high(1 % 0x10000) 
0596 753600     250            mov y+2, #low (1 / 0x10000) 
0599 753700     250            mov y+3, #high(1 / 0x10000) 
059C 120202     251       lcall sub32
059F E530       252       mov a, x
05A1 D4         253       da a
05A2 F541       254       mov p1points, a
05A4 E4         255       clr a
05A5 0204E5     256       ljmp start_game
05A8            257   
05A8            258   start_game_nohit2:
05A8 2002C9     259       jb p2_press, start_game_nohit1
05AB C002       260            push AR2
05AD 7A32       260            mov R2, #50
05AF 12007B     260            lcall ?Wait_Milli_Seconds
05B2 D002       260            pop AR2
05B4 2002BD     261       jb p2_press, start_game_nohit1
05B7 3002FD     262       jnb p2_press, $
05BA C28C       263       clr TR0
05BC E4         264       clr a 
05BD E542       265       mov a, p2points
05BF B4001A     266       cjne a, #0x00, start_jmp
05C2 F530       267       mov x, a
05C4 753401     268            mov y+0, #low (1 % 0x10000) 
05C7 753500     268            mov y+1, #high(1 % 0x10000) 
05CA 753600     268            mov y+2, #low (1 / 0x10000) 
05CD 753700     268            mov y+3, #high(1 / 0x10000) 
05D0 120202     269       lcall sub32
05D3 E530       270       mov a, x
05D5 D4         271       da a
05D6 F542       272       mov p2points, a
05D8 E4         273       clr a
05D9 0205DC     274       ljmp start_jmp
05DC            275   
05DC            276   start_jmp:
05DC 0204E5     277       ljmp start_game
05DF            278   p1win:  
05DF C0E0       279            push acc
05E1 7409       279            mov a, #9
05E3 14         279            dec a
05E4 120101     279            lcall ?Set_Cursor_1 ; Select column and row
05E7 D0E0       279            pop acc
05E9 C083       280            push dph
05EB C082       280            push dpl
05ED C0E0       280            push acc
05EF 900034     280            mov dptr, #Winner1_message1
05F2 1200F4     280            lcall ?Send_Constant_String
05F5 D0E0       280            pop acc
05F7 D082       280            pop dpl
05F9 D083       280            pop dph
05FB C083       281            push dph
05FD C082       281            push dpl
05FF C0E0       281            push acc
0601 90003E     281            mov dptr, #Winner1_message2
0604 1200F4     281            lcall ?Send_Constant_String
0607 D0E0       281            pop acc
0609 D082       281            pop dpl
060B D083       281            pop dph
060D C002       282            push AR2
060F 7A05       282            mov R2, #5
0611 12007B     282            lcall ?Wait_Milli_Seconds
0614 D002       282            pop AR2
0616            282   
0616 C0E0       283            push acc
0618 7401       283            mov a, #1
061A 14         283            dec a
061B 120101     283            lcall ?Set_Cursor_1 ; Select column and row
061E D0E0       283            pop acc
0620 C083       284            push dph
0622 C082       284            push dpl
0624 C0E0       284            push acc
0626 900058     284            mov dptr, #Playagain
0629 1200F4     284            lcall ?Send_Constant_String
062C D0E0       284            pop acc
062E D082       284            pop dpl
0630 D083       284            pop dph
0632 C0E0       285            push acc
0634 7401       285            mov a, #1
0636 14         285            dec a
0637 1200FF     285            lcall ?Set_Cursor_2 ; Select column and row
063A D0E0       285            pop acc
063C C083       286            push dph
063E C082       286            push dpl
0640 C0E0       286            push acc
0642 900065     286            mov dptr, #Clear_screen
0645 1200F4     286            lcall ?Send_Constant_String
0648 D0E0       286            pop acc
064A D082       286            pop dpl
064C D083       286            pop dph
064E 20808E     287       jb START_BUTTON, p1win
0651 C002       288            push AR2
0653 7A05       288            mov R2, #5
0655 12007B     288            lcall ?Wait_Milli_Seconds
0658 D002       288            pop AR2
065A 208082     289       jb START_BUTTON, p1win
065D 3080FD     290       jnb START_BUTTON, $
0660 0206FA     291       ljmp restart_jmp
0663            292   p1win_jmp2:
0663 0205DF     293       ljmp p1win
0666            294   p2win: 
0666 C0E0       295            push acc
0668 7409       295            mov a, #9
066A 14         295            dec a
066B 120101     295            lcall ?Set_Cursor_1 ; Select column and row
066E D0E0       295            pop acc
0670 C083       296            push dph
0672 C082       296            push dpl
0674 C0E0       296            push acc
0676 900046     296            mov dptr, #Winner2_message1
0679 1200F4     296            lcall ?Send_Constant_String
067C D0E0       296            pop acc
067E D082       296            pop dpl
0680 D083       296            pop dph
0682 C0E0       297            push acc
0684 7409       297            mov a, #9
0686 14         297            dec a
0687 1200FF     297            lcall ?Set_Cursor_2 ; Select column and row
068A D0E0       297            pop acc
068C C083       298            push dph
068E C082       298            push dpl
0690 C0E0       298            push acc
0692 90004E     298            mov dptr, #Winner2_message2
0695 1200F4     298            lcall ?Send_Constant_String
0698 D0E0       298            pop acc
069A D082       298            pop dpl
069C D083       298            pop dph
069E C002       299            push AR2
06A0 7A32       299            mov R2, #50
06A2 12007B     299            lcall ?Wait_Milli_Seconds
06A5 D002       299            pop AR2
06A7 C0E0       300            push acc
06A9 7401       300            mov a, #1
06AB 14         300            dec a
06AC 120101     300            lcall ?Set_Cursor_1 ; Select column and row
06AF D0E0       300            pop acc
06B1 C083       301            push dph
06B3 C082       301            push dpl
06B5 C0E0       301            push acc
06B7 900058     301            mov dptr, #Playagain
06BA 1200F4     301            lcall ?Send_Constant_String
06BD D0E0       301            pop acc
06BF D082       301            pop dpl
06C1 D083       301            pop dph
06C3 C0E0       302            push acc
06C5 7401       302            mov a, #1
06C7 14         302            dec a
06C8 1200FF     302            lcall ?Set_Cursor_2 ; Select column and row
06CB D0E0       302            pop acc
06CD C083       303            push dph
06CF C082       303            push dpl
06D1 C0E0       303            push acc
06D3 900065     303            mov dptr, #Clear_screen
06D6 1200F4     303            lcall ?Send_Constant_String
06D9 D0E0       303            pop acc
06DB D082       303            pop dpl
06DD D083       303            pop dph
06DF 208015     304       jb START_BUTTON, p2win_jmp1
06E2 C002       305            push AR2
06E4 7A32       305            mov R2, #50
06E6 12007B     305            lcall ?Wait_Milli_Seconds
06E9 D002       305            pop AR2
06EB 208009     306       jb START_BUTTON, p2win_jmp1
06EE 3080FD     307       jnb START_BUTTON, $
06F1 0206FA     308       ljmp restart_jmp
06F4            309   
06F4            310   p1win_jmp1:
06F4 0205DF     311       ljmp p1win
06F7            312   
06F7            313   p2win_jmp1:
06F7 020666     314       ljmp p2win
06FA            315   
06FA            316   restart_jmp:
06FA 0206FD     317       ljmp restart_game
06FD            318   
06FD            319   restart_game:
06FD 754100     320       mov p1points, #0x00
0700 754200     321       mov p2points, #0x00
0703 0204E5     322       ljmp start_game
0706            323   en
