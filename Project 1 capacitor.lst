                  2   $LIST
0000              4   
0000              5   
0000              6   START_BUTTON     equ P0.0
0000              7   P1_BUTTON                equ     P2.4
0000              8   P2_BUTTON            equ         P2.6
0000              9   
0000             10   CLK           EQU 22118400
0000             11   TIMER0_RATE   EQU 2048     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             12   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             13   TIMER1_RATE   EQU 4000                 ;2000Hz frequency lose frequency
0000             14   TIMER2_RATE   EQU 4200                 ;2100Hz frequency win frequency
0000             15   TIMER1_RELOAD EQU ((65536-(CLK/TIMER1_RATE)))
0000             16   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             17   
0000             18   org 0000H
0000 020453      19      ljmp MyProgram
0003             20   
000B             21   org 0x000B
000B 0203CB      22            ljmp Timer0_ISR
000E             23   
0030             24   DSEG at 30H
0030             25   x:   ds 4
0034             26   y:   ds 4
0038             27   seed: ds 4  
003C             28   bcd: ds 5
0041             29   p1points: ds 1
0042             30   p2points: ds 1
0043             31   
0000             32   BSEG
0000             33   mf: dbit 1
0001             34   p1_press: dbit 1
0002             35   p2_press: dbit 1
0003             36   
000E             37   cseg
000E             38   ; These 'equ' must match the hardware wiring
000E             39   LCD_RS equ P3.2
000E             40   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
000E             41   LCD_E  equ P3.3
000E             42   LCD_D4 equ P3.4
000E             43   LCD_D5 equ P3.5
000E             44   LCD_D6 equ P3.6
000E             45   LCD_D7 equ P3.7
000E             46   SOUND_OUT equ P1.1
000E             47   
000E 506C6179    48   Initial_Message:  db 'Player1:          ', 0
     6572313A
     20202020
     20202020
     202000
0021 506C6179    49   Initial_Message2: db 'Player2:          ', 0
     6572323A
     20202020
     20202020
     202000
0034             50   
0034 57696E6E    51   Winner1_message1: db 'Winner!:D', 0
     6572213A
     4400
003E 4C6F7365    52   Winner1_message2: db 'Loser:P', 0
     723A5000
0046             53   
0046 4C6F7365    54   Winner2_message1: db 'Loser:P', 0
     723A5000
004E 57696E6E    55   Winner2_message2: db 'Winner!:D', 0
     6572213A
     4400
0058             56   
0058 506C6179    57   Playagain       : db 'Play again ?', 0
     20616761
     696E203F
     00
0065 20202020    58   Clear_screen    : db '          ', 0
     20202020
     202000
0070             59   
                570   $LIST
                 62   $LIST
03B2             64   
03B2             65   Timer0_Init:
03B2 E589        66            mov a, TMOD
03B4 54F0        67            anl a, #0xf0 ; Clear the bits for timer 0
03B6 4401        68            orl a, #0x01 ; Configure timer 0 as 16-timer
03B8 F589        69            mov TMOD, a
03BA 758CD5      70            mov TH0, #high(TIMER0_RELOAD)
03BD 758AD0      71            mov TL0, #low(TIMER0_RELOAD)
03C0             72            ; Set autoreload value
03C0 75F4D5      73            mov RH0, #high(TIMER0_RELOAD)
03C3 75F2D0      74            mov RL0, #low(TIMER0_RELOAD)
03C6             75            ; Enable the timer and interrupts
03C6 D2A9        76       setb ET0  ; Enable timer 0 interrupt
03C8 C28C        77       clr TR0  ; Start timer 0
03CA 22          78            ret
03CB             79   
03CB             80   ;---------------------------------;
03CB             81   ; ISR for timer 0.  Set to execute;
03CB             82   ; every 1/4096Hz to generate a    ;
03CB             83   ; 2048 Hz square wave at pin P1.1 ;
03CB             84   ;---------------------------------;
03CB             85   Timer0_ISR:
03CB             86            ;clr TF0  ; According to the data sheet this is done for us already.
03CB B291        87            cpl SOUND_OUT ; Connect speaker to P1.1!
03CD 32          88            reti
03CE             89   
03CE             90   Timer0_Init1:
03CE E589        91            mov a, TMOD
03D0 54F0        92            anl a, #0xf0 ; Clear the bits for timer 0
03D2 4401        93            orl a, #0x01 ; Configure timer 0 as 16-timer
03D4 F589        94            mov TMOD, a
03D6 758CEA      95            mov TH0, #high(TIMER1_RELOAD)
03D9 758A67      96            mov TL0, #low(TIMER1_RELOAD)
03DC             97            ; Set autoreload value
03DC 75F4EA      98            mov RH0, #high(TIMER1_RELOAD)
03DF 75F267      99            mov RL0, #low(TIMER1_RELOAD)
03E2            100            ; Enable the timer and interrupts
03E2 D2A9       101       setb ET0  ; Enable timer 0 interrupt
03E4 C28C       102       clr TR0  ; Start timer 0
03E6 22         103            ret
03E7            104   
03E7            105   ;---------------------------------;
03E7            106   ; ISR for timer 0.  Set to execute;
03E7            107   ; every 1/4096Hz to generate a    ;
03E7            108   ; 2048 Hz square wave at pin P1.1 ;
03E7            109   ;---------------------------------;
03E7            110   Timer0_ISR1:
03E7            111            ;clr TF0  ; According to the data sheet this is done for us already.
03E7 B291       112            cpl SOUND_OUT ; Connect speaker to P1.1!
03E9 32         113            reti
03EA            114   
03EA            115   
03EA            116   ;---------------------------------;
03EA            117   ; ISR for timer 0.  Set to execute;
03EA            118   ; every 1/4096Hz to generate a    ;
03EA            119   ; 2048 Hz square wave at pin P1.1 ;
03EA            120   ;---------------------------------;
03EA            121   
03EA            122   
03EA            123   Wait1s:
03EA 7AB0       124       mov R2, #176
03EC 79FA       125   X3: mov R1, #250
03EE 78A6       126   X2: mov R0, #166
03F0 D8FE       127   X1: djnz R0, X1 ; 3 cycles->3*45.21123ns*166=22.51519us
03F2 D9FA       128       djnz R1, X2 ; 22.51519us*250=5.629ms
03F4 DAF6       129       djnz R2, X3 ; 5.629ms*176=1.0s (approximately)
03F6 22         130       ret
03F7            131   
03F7            132   random:
03F7 853830     133       mov x+0, seed+0
03FA 853931     134       mov x+1, seed+1
03FD 853A32     135       mov x+2, seed+2
0400 853B33     136       mov x+3, seed+3
0403 7534FD     137            mov y+0, #low (214013 % 0x10000) 
0406 753543     137            mov y+1, #high(214013 % 0x10000) 
0409 753603     137            mov y+2, #low (214013 / 0x10000) 
040C 753700     137            mov y+3, #high(214013 / 0x10000) 
040F 120296     138       lcall mul32
0412 753443     139            mov y+0, #low (2451011 % 0x10000) 
0415 753566     139            mov y+1, #high(2451011 % 0x10000) 
0418 753625     139            mov y+2, #low (2451011 / 0x10000) 
041B 753700     139            mov y+3, #high(2451011 / 0x10000) 
041E 1201E1     140       lcall add32
0421 853038     141       mov seed+0, x+0
0424 853139     142       mov seed+1, x+1
0427 85323A     143       mov seed+2, x+2
042A 85333B     144       mov seed+3, x+3
042D 22         145       ret
042E            146   wait_random:
042E C002       147            push AR2
0430 AA38       147            mov R2, seed+0
0432 12007B     147            lcall ?Wait_Milli_Seconds
0435 D002       147            pop AR2
0437 C002       148            push AR2
0439 AA39       148            mov R2, seed+1
043B 12007B     148            lcall ?Wait_Milli_Seconds
043E D002       148            pop AR2
0440 C002       149            push AR2
0442 AA3A       149            mov R2, seed+2
0444 12007B     149            lcall ?Wait_Milli_Seconds
0447 D002       149            pop AR2
0449 C002       150            push AR2
044B AA3B       150            mov R2, seed+3
044D 12007B     150            lcall ?Wait_Milli_Seconds
0450 D002       150            pop AR2
0452 22         151       ret
0453            152   
0453            153   MyProgram:
0453 1203B2     154       lcall Timer0_Init
0456            155       ;lcall Timer2_Init
0456 C0E0       156            push acc
0458 7401       156            mov a, #1
045A 14         156            dec a
045B 120101     156            lcall ?Set_Cursor_1 ; Select column and row
045E D0E0       156            pop acc
0460 C083       157            push dph
0462 C082       157            push dpl
0464 C0E0       157            push acc
0466 90000E     157            mov dptr, #Initial_Message
0469 1200F4     157            lcall ?Send_Constant_String
046C D0E0       157            pop acc
046E D082       157            pop dpl
0470 D083       157            pop dph
0472 C0E0       158            push acc
0474 7401       158            mov a, #1
0476 14         158            dec a
0477 1200FF     158            lcall ?Set_Cursor_2 ; Select column and row
047A D0E0       158            pop acc
047C C083       159            push dph
047E C082       159            push dpl
0480 C0E0       159            push acc
0482 900021     159            mov dptr, #Initial_Message2
0485 1200F4     159            lcall ?Send_Constant_String
0488 D0E0       159            pop acc
048A D082       159            pop dpl
048C D083       159            pop dph
048E D2AF       160       setb EA
0490 20C5FD     161       jb P4.5, $
0493 85CD38     162       mov seed+0, TH2
0496 753901     163       mov seed+1, #0x01
0499 753A87     164       mov seed+2, #0x87
049C 85CC3B     165       mov seed+3, TL2
049F 754100     166       mov p1points, #0x00
04A2 754200     167       mov p2points, #0x00
04A5 C28C       168       clr TR0
04A7 C2CA       169       clr TR2
04A9 0204AC     170       ljmp loop
04AC            171   loop:
04AC C0E0       172            push acc
04AE 740B       172            mov a, #11
04B0 14         172            dec a
04B1 120101     172            lcall ?Set_Cursor_1 ; Select column and row
04B4 D0E0       172            pop acc
04B6 C000       173            push ar0
04B8 A841       173            mov r0, p1points
04BA 120106     173            lcall ?Display_BCD
04BD D000       173            pop ar0
04BF C0E0       174            push acc
04C1 740B       174            mov a, #11
04C3 14         174            dec a
04C4 1200FF     174            lcall ?Set_Cursor_2 ; Select column and row
04C7 D0E0       174            pop acc
04C9 C000       175            push ar0
04CB A842       175            mov r0, p2points
04CD 120106     175            lcall ?Display_BCD
04D0 D000       175            pop ar0
04D2 208012     176       jb START_BUTTON, start_game
04D5 C002       177            push AR2
04D7 7A32       177            mov R2, #50
04D9 12007B     177            lcall ?Wait_Milli_Seconds
04DC D002       177            pop AR2
04DE 208006     178       jb START_BUTTON, start_game
04E1 3080FD     179       jnb START_BUTTON, $
04E4 0204AC     180       ljmp loop
04E7            181   
04E7            182   start_game:
04E7 C0E0       183            push acc
04E9 740B       183            mov a, #11
04EB 14         183            dec a
04EC 120101     183            lcall ?Set_Cursor_1 ; Select column and row
04EF D0E0       183            pop acc
04F1 C000       184            push ar0
04F3 A841       184            mov r0, p1points
04F5 120106     184            lcall ?Display_BCD
04F8 D000       184            pop ar0
04FA C0E0       185            push acc
04FC 740B       185            mov a, #11
04FE 14         185            dec a
04FF 1200FF     185            lcall ?Set_Cursor_2 ; Select column and row
0502 D0E0       185            pop acc
0504 C000       186            push ar0
0506 A842       186            mov r0, p2points
0508 120106     186            lcall ?Display_BCD
050B D000       186            pop ar0
050D 1203F7     187       lcall random
0510 12042E     188       lcall wait_random
0513 E539       189       mov a, seed+1
0515 A2E3       190       mov c, acc.3
0517            191       ;mov HLbit, c
0517 4003       192       jc lose_tone
0519 020524     193       ljmp win_tone
051C            194   
051C            195   lose_tone:
051C            196       ;ljmp play_lose
051C 1203CE     197       lcall Timer0_Init1
051F D28C       198       setb TR0
0521 020576     199       ljmp start_game_nohit1
0524            200   win_tone: 
0524            201       ;ljmp play_win
0524 1203CE     202       lcall Timer0_Init1
0527 D28C       203       setb TR0
0529 02052C     204       ljmp start_game_hit1
052C            205       
052C            206   
052C            207   start_game_hit1:
052C 20A422     208       jb P1_BUTTON, start_game_hit2
052F C002       209            push AR2
0531 7A32       209            mov R2, #50
0533 12007B     209            lcall ?Wait_Milli_Seconds
0536 D002       209            pop AR2
0538 20A416     210       jb P1_BUTTON, start_game_hit2
053B 30A4FD     211       jnb P1_BUTTON, $
053E C28C       212       clr TR0
0540 E4         213       clr a 
0541 E541       214       mov a, p1points
0543 2401       215       add a, #0x01
0545 F542       216       mov p2points, a
0547 B40504     217       cjne a, #0x05, p1win_jmp
054A E4         218       clr a
054B 0204E7     219       ljmp start_game
054E            220   
054E            221   p1win_jmp:
054E 0205E1     222       ljmp p1win
0551            223   
0551            224   start_game_hit2:
0551 20A6D8     225       jb P2_BUTTON, start_game_hit1
0554 C002       226            push AR2
0556 7A32       226            mov R2, #50
0558 12007B     226            lcall ?Wait_Milli_Seconds
055B D002       226            pop AR2
055D 20A6CC     227       jb P2_BUTTON, start_game_hit1
0560 30A6FD     228       jnb P2_BUTTON, $
0563 C28C       229       clr TR0
0565 E4         230       clr a 
0566 E542       231       mov a, p2points
0568 2401       232       add a, #0x01
056A F542       233       mov p2points, a
056C B40504     234       cjne a, #0x05, p2win_jmp
056F E4         235       clr a
0570 0204E7     236       ljmp start_game
0573            237   
0573            238   p2win_jmp:
0573 020668     239       ljmp p2win
0576            240   
0576            241   start_game_nohit1:
0576 20A431     242       jb P1_BUTTON, start_game_nohit2
0579 C002       243            push AR2
057B 7A32       243            mov R2, #50
057D 12007B     243            lcall ?Wait_Milli_Seconds
0580 D002       243            pop AR2
0582 20A425     244       jb P1_BUTTON, start_game_nohit2
0585 30A4FD     245       jnb P1_BUTTON, $
0588 C28C       246       clr TR0
058A E4         247       clr a 
058B E541       248       mov a, p1points
058D B4004E     249       cjne a, #0x00, start_jmp
0590 F530       250       mov x, a
0592 753401     251            mov y+0, #low (1 % 0x10000) 
0595 753500     251            mov y+1, #high(1 % 0x10000) 
0598 753600     251            mov y+2, #low (1 / 0x10000) 
059B 753700     251            mov y+3, #high(1 / 0x10000) 
059E 120202     252       lcall sub32
05A1 E530       253       mov a, x
05A3 D4         254       da a
05A4 F541       255       mov p1points, a
05A6 E4         256       clr a
05A7 0204E7     257       ljmp start_game
05AA            258   
05AA            259   start_game_nohit2:
05AA 20A6C9     260       jb P2_BUTTON, start_game_nohit1
05AD C002       261            push AR2
05AF 7A32       261            mov R2, #50
05B1 12007B     261            lcall ?Wait_Milli_Seconds
05B4 D002       261            pop AR2
05B6 20A6BD     262       jb P2_BUTTON, start_game_nohit1
05B9 30A6FD     263       jnb P2_BUTTON, $
05BC C28C       264       clr TR0
05BE E4         265       clr a 
05BF E542       266       mov a, p2points
05C1 B4001A     267       cjne a, #0x00, start_jmp
05C4 F530       268       mov x, a
05C6 753401     269            mov y+0, #low (1 % 0x10000) 
05C9 753500     269            mov y+1, #high(1 % 0x10000) 
05CC 753600     269            mov y+2, #low (1 / 0x10000) 
05CF 753700     269            mov y+3, #high(1 / 0x10000) 
05D2 120202     270       lcall sub32
05D5 E530       271       mov a, x
05D7 D4         272       da a
05D8 F542       273       mov p2points, a
05DA E4         274       clr a
05DB 0205DE     275       ljmp start_jmp
05DE            276   
05DE            277   start_jmp:
05DE 0204E7     278       ljmp start_game
05E1            279   p1win:  
05E1 C0E0       280            push acc
05E3 7409       280            mov a, #9
05E5 14         280            dec a
05E6 120101     280            lcall ?Set_Cursor_1 ; Select column and row
05E9 D0E0       280            pop acc
05EB C083       281            push dph
05ED C082       281            push dpl
05EF C0E0       281            push acc
05F1 900034     281            mov dptr, #Winner1_message1
05F4 1200F4     281            lcall ?Send_Constant_String
05F7 D0E0       281            pop acc
05F9 D082       281            pop dpl
05FB D083       281            pop dph
05FD C083       282            push dph
05FF C082       282            push dpl
0601 C0E0       282            push acc
0603 90003E     282            mov dptr, #Winner1_message2
0606 1200F4     282            lcall ?Send_Constant_String
0609 D0E0       282            pop acc
060B D082       282            pop dpl
060D D083       282            pop dph
060F C002       283            push AR2
0611 7A05       283            mov R2, #5
0613 12007B     283            lcall ?Wait_Milli_Seconds
0616 D002       283            pop AR2
0618            283   
0618 C0E0       284            push acc
061A 7401       284            mov a, #1
061C 14         284            dec a
061D 120101     284            lcall ?Set_Cursor_1 ; Select column and row
0620 D0E0       284            pop acc
0622 C083       285            push dph
0624 C082       285            push dpl
0626 C0E0       285            push acc
0628 900058     285            mov dptr, #Playagain
062B 1200F4     285            lcall ?Send_Constant_String
062E D0E0       285            pop acc
0630 D082       285            pop dpl
0632 D083       285            pop dph
0634 C0E0       286            push acc
0636 7401       286            mov a, #1
0638 14         286            dec a
0639 1200FF     286            lcall ?Set_Cursor_2 ; Select column and row
063C D0E0       286            pop acc
063E C083       287            push dph
0640 C082       287            push dpl
0642 C0E0       287            push acc
0644 900065     287            mov dptr, #Clear_screen
0647 1200F4     287            lcall ?Send_Constant_String
064A D0E0       287            pop acc
064C D082       287            pop dpl
064E D083       287            pop dph
0650 20A612     288       jb P2_BUTTON, p1win_jmp2
0653 C002       289            push AR2
0655 7A05       289            mov R2, #5
0657 12007B     289            lcall ?Wait_Milli_Seconds
065A D002       289            pop AR2
065C 20A606     290       jb P2_BUTTON, p1win_jmp2
065F 30A6FD     291       jnb P2_BUTTON, $
0662 0206FC     292       ljmp restart_jmp
0665            293   p1win_jmp2:
0665 0205E1     294       ljmp p1win
0668            295   p2win: 
0668 C0E0       296            push acc
066A 7409       296            mov a, #9
066C 14         296            dec a
066D 120101     296            lcall ?Set_Cursor_1 ; Select column and row
0670 D0E0       296            pop acc
0672 C083       297            push dph
0674 C082       297            push dpl
0676 C0E0       297            push acc
0678 900046     297            mov dptr, #Winner2_message1
067B 1200F4     297            lcall ?Send_Constant_String
067E D0E0       297            pop acc
0680 D082       297            pop dpl
0682 D083       297            pop dph
0684 C0E0       298            push acc
0686 7409       298            mov a, #9
0688 14         298            dec a
0689 1200FF     298            lcall ?Set_Cursor_2 ; Select column and row
068C D0E0       298            pop acc
068E C083       299            push dph
0690 C082       299            push dpl
0692 C0E0       299            push acc
0694 90004E     299            mov dptr, #Winner2_message2
0697 1200F4     299            lcall ?Send_Constant_String
069A D0E0       299            pop acc
069C D082       299            pop dpl
069E D083       299            pop dph
06A0 C002       300            push AR2
06A2 7A32       300            mov R2, #50
06A4 12007B     300            lcall ?Wait_Milli_Seconds
06A7 D002       300            pop AR2
06A9 C0E0       301            push acc
06AB 7401       301            mov a, #1
06AD 14         301            dec a
06AE 120101     301            lcall ?Set_Cursor_1 ; Select column and row
06B1 D0E0       301            pop acc
06B3 C083       302            push dph
06B5 C082       302            push dpl
06B7 C0E0       302            push acc
06B9 900058     302            mov dptr, #Playagain
06BC 1200F4     302            lcall ?Send_Constant_String
06BF D0E0       302            pop acc
06C1 D082       302            pop dpl
06C3 D083       302            pop dph
06C5 C0E0       303            push acc
06C7 7401       303            mov a, #1
06C9 14         303            dec a
06CA 1200FF     303            lcall ?Set_Cursor_2 ; Select column and row
06CD D0E0       303            pop acc
06CF C083       304            push dph
06D1 C082       304            push dpl
06D3 C0E0       304            push acc
06D5 900065     304            mov dptr, #Clear_screen
06D8 1200F4     304            lcall ?Send_Constant_String
06DB D0E0       304            pop acc
06DD D082       304            pop dpl
06DF D083       304            pop dph
06E1 20A612     305       jb P2_BUTTON, p1win_jmp1
06E4 C002       306            push AR2
06E6 7A32       306            mov R2, #50
06E8 12007B     306            lcall ?Wait_Milli_Seconds
06EB D002       306            pop AR2
06ED 20A606     307       jb P2_BUTTON, p1win_jmp1
06F0 30A6FD     308       jnb P2_BUTTON, $
06F3 0206FC     309       ljmp restart_jmp
06F6            310   
06F6            311   p1win_jmp1:
06F6 0205E1     312       ljmp p1win
06F9            313   
06F9            314   p2win_jmp2:
06F9 020668     315       ljmp p2win
06FC            316   
06FC            317   restart_jmp:
06FC 0206FF     318       ljmp restart_game
06FF            319   
06FF            320   restart_game:
06FF 754100     321       mov p1points, #0x00
0702 754200     322       mov p2points, #0x00
0705 0204E7     323       ljmp start_game
0708            324   en
